name: Build and Test

on:
    push:
        branches:
            - master
        tags:
            - v*
    pull_request:
        branches:
            - '**'

jobs:
    build-test-linux:
        name: Build-Test-Linux
        runs-on: ubuntu-latest
        strategy:
            matrix:
                build_type: [ 'Debug', 'Release' ]
                cloud_provider: [ 'AWS', 'AZURE', 'GCP' ]
        steps:
            - uses: actions/checkout@v1
            - name: Build
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
              run: ci/build_linux.sh
            - uses: actions/setup-python@v1
              with:
                python-version: '3.7'
                architecture: 'x64'
            - name: Test
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
                  CLOUD_PROVIDER: ${{ matrix.cloud_provider }}
                  PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}
              run: ci/test_linux.sh
    build-test-win:
        name: Build-Test-Win
        runs-on: windows-2019
        strategy:
            matrix:
                platform: [ 'x64', 'x86' ]
                build_type: [ 'Debug', 'Release' ]
                vs_version: [ 'VS16' ]
                cloud_provider: [ 'AWS', 'AZURE', 'GCP' ]
        steps:
            - uses: actions/checkout@v1
            - name: Build
              shell: cmd
              env:
                  PLATFORM: ${{ matrix.platform }}
                  BUILD_TYPE: ${{ matrix.build_type }}
                  VS_VERSION: ${{ matrix.vs_version }}
              run: ci\build_win.bat
            - uses: actions/setup-python@v1
              with:
                python-version: '3.7'
                architecture: 'x64'
            - name: Test
              shell: cmd
              env:
                  PLATFORM: ${{ matrix.platform }}
                  BUILD_TYPE: ${{ matrix.build_type }}
                  VS_VERSION: ${{ matrix.vs_version }}
                  CLOUD_PROVIDER: ${{ matrix.cloud_provider }}
                  PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}
              run: ci\test_win.bat
#    build-test-mac:
#        name: Build-Test-Mac
#        runs-on: macos-10.15
#        strategy:
#            matrix:
#                build_type: [ 'Debug' ]
#                cloud_provider: [ 'AWS' ]
#        steps:
#            - uses: actions/checkout@v1
#            - name: Install Homebrew Bash
#              shell: bash
#              run: brew install bash
#            - name: Build
#              shell: bash
#              env:
#                PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}
#                BUILD_TYPE: ${{ matrix.build_type }}
#                CLOUD_PROVIDER: ${{ matrix.cloud }}
#              run: /usr/local/bin/bash ./ci/build_mac.sh
    build-test-codecov:
        name: Build-Test-CodeCov-Linux
        runs-on: ubuntu-latest
        strategy:
            matrix:
                build_type: [ 'Release' ]
        steps:
            - uses: actions/checkout@v3
            - name: Build
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
                  CLIENT_CODE_COVERAGE: 1
              run: ci/build_linux.sh
            - uses: actions/setup-python@v1
              with:
                python-version: '3.7'
                architecture: 'x64'
            - name: Setup LCOV
              shell: bash
              run: sudo apt-get -y install lcov
            - name: Test on AWS
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
                  CLIENT_CODE_COVERAGE: 1
                  CLOUD_PROVIDER: AWS
                  PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}
              run: ci/test_linux.sh
            - name: Test on Azure
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
                  CLIENT_CODE_COVERAGE: 1
                  CLOUD_PROVIDER: AZURE
                  PARAMETERS_SECRET: ${{ secrets.PARAMETERS_SECRET }}
              run: ci/test_linux.sh
            - name: Run LCOV
              shell: bash
              env:
                  BUILD_TYPE: ${{ matrix.build_type }}
              run: scripts/gen_lcov.sh
            # codecov action sometimes fails but retry works - until action provides retry let's retry on our own https://github.com/codecov/codecov-action/issues/926
            - name: Upload coverage reports to Codecov (take 1)
              id: uploadToCodeCovTake1
              uses: codecov/codecov-action@v3
              continue-on-error: true
              with:
                fail_ci_if_error: true
                verbose: true
            - name: Upload coverage reports to Codecov (take 2)
              id: uploadToCodeCovTake2
              # only run when take 1 failed
              if: steps.uploadToCodeCovTake1.outcome == 'failure'
              uses: codecov/codecov-action@v3
              with:
                fail_ci_if_error: true
                verbose: true
