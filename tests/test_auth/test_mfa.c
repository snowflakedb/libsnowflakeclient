#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "auth_utils.h"

char** getTotpCodes(const char* seed) {
    char command[512];
    const char *totpGeneratorPath = "/externalbrowser/totpGenerator.js";
    
    snprintf(command, sizeof(command), "node %s %s", totpGeneratorPath, seed ? seed : "");
    
    FILE *pipe = popen(command, "r");
    if (!pipe) {
        return NULL;
    }
    
    char buffer[1024];
    char *output = fgets(buffer, sizeof(buffer), pipe);
    pclose(pipe);
    
    if (!output) {
        return NULL;
    }
    
    char *newline = strchr(output, '\n');
    if (newline) *newline = '\0';
    
    char **codes = malloc(sizeof(char*) * 3);
    codes[0] = codes[1] = codes[2] = NULL;
    
    int count = 0;
    char *token = strtok(output, " ");
    while (token && count < 3) {
        codes[count] = malloc(strlen(token) + 1);
        strcpy(codes[count], token);
        count++;
        token = strtok(NULL, " ");
    }
    
    return codes;
}

void freeTotpCodes(char** codes) {
    if (!codes) return;
    for (int i = 0; i < 3; i++) {
        if (codes[i]) free(codes[i]);
    }
    free(codes);
}

void test_mfa_totp_authentication(void **unused) {
    SF_UNUSED(unused);

    SF_CONNECT *sf = snowflake_init();
    set_all_snowflake_attributes(sf);
    
    snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
    snowflake_set_attribute(sf, SF_CON_USER, getenv("SNOWFLAKE_AUTH_TEST_MFA_USER"));
    snowflake_set_attribute(sf, SF_CON_PASSWORD, getenv("SNOWFLAKE_AUTH_TEST_MFA_PASSWORD"));
    
    snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
    
    char** totpCodes = getTotpCodes("");
    
    if (!totpCodes) {
        snowflake_term(sf);
        fail_msg("No TOTP codes were generated by getTotpCodes() - test cannot proceed");
        return;
    }
    
    char lastError[1024] = {0};
    
    for (int i = 0; i < 3 && totpCodes[i]; i++) {
        printf("Trying TOTP code %d: %s\n", i + 1, totpCodes[i]);
        
        snowflake_set_attribute(sf, SF_CON_PASSCODE, totpCodes[i]);
        
        SF_STATUS status = snowflake_connect(sf);
        
        if (status == SF_STATUS_SUCCESS) {
            printf("MFA authentication successful with TOTP code %d\n", i + 1);
            
            snowflake_term(sf);
            
            sf = snowflake_init();
            set_all_snowflake_attributes(sf);
            snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
            snowflake_set_attribute(sf, SF_CON_USER, getenv("SNOWFLAKE_AUTH_TEST_MFA_USER"));
            snowflake_set_attribute(sf, SF_CON_PASSWORD, getenv("SNOWFLAKE_AUTH_TEST_MFA_PASSWORD"));
            snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
            
            SF_STATUS cacheStatus = snowflake_connect(sf);
            
            if (cacheStatus == SF_STATUS_SUCCESS) {
                printf("SUCCESS: MFA authentication and caching completed successfully\n");
                freeTotpCodes(totpCodes);
                snowflake_term(sf);
                return; // Success - exit test
            } else {
                SF_ERROR_STRUCT* error = snowflake_error(sf);
                snprintf(lastError, sizeof(lastError), "MFA token caching failed: %s", 
                        error ? error->msg : "Unknown error");
                break; 
            }
        } else {
            SF_ERROR_STRUCT* error = snowflake_error(sf);
            const char* errorMsg = error ? error->msg : "Unknown error";
            snprintf(lastError, sizeof(lastError), "%s", errorMsg);
            
            if (strstr(errorMsg, "Invalid") || strstr(errorMsg, "TOTP") ||
                strstr(errorMsg, "passcode") || strstr(errorMsg, "MFA")) {
                printf("WARN: TOTP attempt %d failed - retrying with next code\n", i + 1);
                continue;
            } else {
                printf("WARN: Non-TOTP error on attempt %d, stopping: %s\n", i + 1, lastError);
                break;
            }
        }
    }
    freeTotpCodes(totpCodes);
    snowflake_term(sf);
    printf("ERROR: Failed to connect with any TOTP codes. Last error: %s\n", lastError);
    fail();
}
