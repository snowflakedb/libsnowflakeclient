#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "auth_utils.h"

char** getTotpCodes(const char* seed) {
    char command[512];
    const char *totpGeneratorPath = "/externalbrowser/totpGenerator.js";
    
    snprintf(command, sizeof(command), "node %s %s", totpGeneratorPath, seed ? seed : "");
    
    FILE *pipe = popen(command, "r");
    if (!pipe) {
        return NULL;
    }
    
    char buffer[1024];
    char *output = fgets(buffer, sizeof(buffer), pipe);
    pclose(pipe);
    
    if (!output) {
        return NULL;
    }
    
    char *newline = strchr(output, '\n');
    if (newline) *newline = '\0';
    
    char **codes = malloc(sizeof(char*) * 3);
    codes[0] = codes[1] = codes[2] = NULL;
    
    int count = 0;
    char *token = strtok(output, " ");
    while (token && count < 3) {
        codes[count] = malloc(strlen(token) + 1);
        strcpy(codes[count], token);
        count++;
        token = strtok(NULL, " ");
    }
    
    return codes;
}

void freeTotpCodes(char** codes) {
    if (!codes) return;
    for (int i = 0; i < 3; i++) {
        if (codes[i]) free(codes[i]);
    }
    free(codes);
}

void test_mfa_totp_authentication(void **unused) {
    SF_UNUSED(unused);

    SF_CONNECT *sf = snowflake_init();
    
    char *mfa_user = getenv("SNOWFLAKE_AUTH_TEST_MFA_USER");
    char *mfa_password = getenv("SNOWFLAKE_AUTH_TEST_MFA_PASSWORD");
    
    printf("DEBUG: MFA_USER = %s\n", mfa_user ? mfa_user : "NULL");
    
    // Check if MFA credentials are available
    if (!mfa_user || !mfa_password) {
        snowflake_term(sf);
        fail_msg("MFA environment variables not set - SNOWFLAKE_AUTH_TEST_MFA_USER and SNOWFLAKE_AUTH_TEST_MFA_PASSWORD required");
        return;
    }
    
    // Debug all connection parameters
    char *account = getenv("SNOWFLAKE_AUTH_TEST_ACCOUNT");
    char *host = getenv("SNOWFLAKE_AUTH_TEST_HOST");
    char *port = getenv("SNOWFLAKE_AUTH_TEST_PORT");
    char *protocol = getenv("SNOWFLAKE_AUTH_TEST_PROTOCOL");
    char *role = getenv("SNOWFLAKE_AUTH_TEST_ROLE");
    
    printf("DEBUG: ACCOUNT = %s\n", account ? account : "NULL");
    printf("DEBUG: HOST = %s\n", host ? host : "NULL");
    printf("DEBUG: PORT = %s\n", port ? port : "NULL");
    printf("DEBUG: PROTOCOL = %s\n", protocol ? protocol : "NULL");
    printf("DEBUG: ROLE = %s\n", role ? role : "NULL");
    
    // Set connection attributes manually to avoid conflicts
    snowflake_set_attribute(sf, SF_CON_ACCOUNT, account);
    snowflake_set_attribute(sf, SF_CON_HOST, host);
    snowflake_set_attribute(sf, SF_CON_PORT, port);
    snowflake_set_attribute(sf, SF_CON_PROTOCOL, protocol);
    snowflake_set_attribute(sf, SF_CON_ROLE, role);
    
    snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
    snowflake_set_attribute(sf, SF_CON_USER, mfa_user);
    snowflake_set_attribute(sf, SF_CON_PASSWORD, mfa_password);
    
    printf("DEBUG: Set authenticator to USERNAME_PASSWORD_MFA\n");
    
    snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
    
    // Test basic connection first without TOTP to isolate the issue
    printf("DEBUG: Testing basic MFA connection without TOTP...\n");
    SF_STATUS basicStatus = snowflake_connect(sf);
    printf("DEBUG: Basic connection status: %d\n", basicStatus);
    
    if (basicStatus != SF_STATUS_SUCCESS) {
        SF_ERROR_STRUCT* basicError = snowflake_error(sf);
        printf("DEBUG: Basic connection error - Code: %d, Message: %s\n", 
               basicError ? basicError->error_code : -1, 
               basicError ? basicError->msg : "Unknown");
        
        // If basic connection fails, no point trying TOTP
        snowflake_term(sf);
        fail_msg("Basic MFA connection failed - check credentials and connection parameters");
        return;
    }
    
    // Disconnect and reconnect for TOTP attempts
    snowflake_term(sf);
    sf = snowflake_init();
    
    // Re-set all attributes for TOTP attempts
    snowflake_set_attribute(sf, SF_CON_ACCOUNT, account);
    snowflake_set_attribute(sf, SF_CON_HOST, host);
    snowflake_set_attribute(sf, SF_CON_PORT, port);
    snowflake_set_attribute(sf, SF_CON_PROTOCOL, protocol);
    snowflake_set_attribute(sf, SF_CON_ROLE, role);
    snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
    snowflake_set_attribute(sf, SF_CON_USER, mfa_user);
    snowflake_set_attribute(sf, SF_CON_PASSWORD, mfa_password);
    snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
          
    char** totpCodes = getTotpCodes("");
    
    if (!totpCodes) {
        snowflake_term(sf);
        fail_msg("No TOTP codes were generated by getTotpCodes() - test cannot proceed");
        return;
    }
    
    char lastError[1024] = {0};
    
    for (int i = 0; i < 3 && totpCodes[i]; i++) {
        printf("Trying TOTP code %d: %s\n", i + 1, totpCodes[i]);
        
        // Reset connection for each attempt to avoid state corruption
        if (i > 0) {
            snowflake_term(sf);
            sf = snowflake_init();
            // Set connection attributes again
            snowflake_set_attribute(sf, SF_CON_ACCOUNT, getenv("SNOWFLAKE_AUTH_TEST_ACCOUNT"));
            snowflake_set_attribute(sf, SF_CON_HOST, getenv("SNOWFLAKE_AUTH_TEST_HOST"));
            snowflake_set_attribute(sf, SF_CON_PORT, getenv("SNOWFLAKE_AUTH_TEST_PORT"));
            snowflake_set_attribute(sf, SF_CON_PROTOCOL, getenv("SNOWFLAKE_AUTH_TEST_PROTOCOL"));
            snowflake_set_attribute(sf, SF_CON_ROLE, getenv("SNOWFLAKE_AUTH_TEST_ROLE"));
            snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
            snowflake_set_attribute(sf, SF_CON_USER, mfa_user);
            snowflake_set_attribute(sf, SF_CON_PASSWORD, mfa_password);
            snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
        }
        
        snowflake_set_attribute(sf, SF_CON_PASSCODE, totpCodes[i]);
        
        SF_STATUS status = snowflake_connect(sf);
        
        if (status == SF_STATUS_SUCCESS) {
            printf("MFA authentication successful with TOTP code %d\n", i + 1);
            
            snowflake_term(sf);
            
            sf = snowflake_init();
            // Set connection attributes manually to avoid conflicts
            snowflake_set_attribute(sf, SF_CON_ACCOUNT, getenv("SNOWFLAKE_AUTH_TEST_ACCOUNT"));
            snowflake_set_attribute(sf, SF_CON_HOST, getenv("SNOWFLAKE_AUTH_TEST_HOST"));
            snowflake_set_attribute(sf, SF_CON_PORT, getenv("SNOWFLAKE_AUTH_TEST_PORT"));
            snowflake_set_attribute(sf, SF_CON_PROTOCOL, getenv("SNOWFLAKE_AUTH_TEST_PROTOCOL"));
            snowflake_set_attribute(sf, SF_CON_ROLE, getenv("SNOWFLAKE_AUTH_TEST_ROLE"));
            
            snowflake_set_attribute(sf, SF_CON_AUTHENTICATOR, "USERNAME_PASSWORD_MFA");
            snowflake_set_attribute(sf, SF_CON_USER, mfa_user);
            snowflake_set_attribute(sf, SF_CON_PASSWORD, mfa_password);
            snowflake_set_attribute(sf, SF_CON_CLIENT_REQUEST_MFA_TOKEN, &(sf_bool){1});
            
            SF_STATUS cacheStatus = snowflake_connect(sf);
            
            if (cacheStatus == SF_STATUS_SUCCESS) {
                printf("SUCCESS: MFA authentication and caching completed successfully\n");
                freeTotpCodes(totpCodes);
                snowflake_term(sf);
                return; // Success - exit test
            } else {
                SF_ERROR_STRUCT* error = snowflake_error(sf);
                snprintf(lastError, sizeof(lastError), "MFA token caching failed: %s", 
                        error ? error->msg : "Unknown error");
                break; 
            }
        } else {
            SF_ERROR_STRUCT* error = snowflake_error(sf);
            const char* errorMsg = error ? error->msg : "Unknown error";
            snprintf(lastError, sizeof(lastError), "%s", errorMsg);
            
            printf("DEBUG: Full error details - Code: %d, Message: %s\n", 
                   error ? error->error_code : -1, errorMsg);

            if (strstr(errorMsg, "Invalid") || strstr(errorMsg, "TOTP") ||
                strstr(errorMsg, "passcode") || strstr(errorMsg, "MFA") ||
                strstr(errorMsg, "authentication failed")) {
                printf("WARN: TOTP attempt %d failed - retrying with next code\n", i + 1);
                continue;
            } else {
                printf("WARN: Non-TOTP error on attempt %d, stopping: %s\n", i + 1, lastError);
                break;
            }
        }
    }
    freeTotpCodes(totpCodes);
    snowflake_term(sf);
    printf("ERROR: Failed to connect with any TOTP codes. Last error: %s\n", lastError);
    fail();
}
